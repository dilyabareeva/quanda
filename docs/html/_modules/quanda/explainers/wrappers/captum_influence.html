<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>quanda.explainers.wrappers.captum_influence &mdash; quanda 01.07.2024 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=cea27b2f"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" >
            
              <img src="../../../../_static/quanda_white.png" class="logo" alt="Logo" style="width: 70%; height: auto;"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started.html">Getting Started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs_api/modules.html">quanda</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">quanda</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">quanda.explainers.wrappers.captum_influence</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for quanda.explainers.wrappers.captum_influence</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">lightning</span> <span class="k">as</span> <span class="nn">L</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">captum._utils.av</span> <span class="kn">import</span> <span class="n">AV</span>  <span class="c1"># type: ignore</span>
<span class="kn">from</span> <span class="nn">captum.influence</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># type: ignore</span>
    <span class="n">SimilarityInfluence</span><span class="p">,</span>
    <span class="n">TracInCP</span><span class="p">,</span>
    <span class="n">TracInCPFast</span><span class="p">,</span>
    <span class="n">TracInCPFastRandProj</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># TODO Should be imported directly from captum.influence once available</span>
<span class="kn">from</span> <span class="nn">captum.influence._core.arnoldi_influence_function</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># type: ignore</span>
    <span class="n">ArnoldiInfluenceFunction</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">captum.influence._utils.nearest_neighbors</span> <span class="kn">import</span> <span class="p">(</span>  <span class="c1"># type: ignore</span>
    <span class="n">NearestNeighbors</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">quanda.explainers.base</span> <span class="kn">import</span> <span class="n">Explainer</span>
<span class="kn">from</span> <span class="nn">quanda.explainers.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">explain_fn_from_explainer</span><span class="p">,</span>
    <span class="n">self_influence_fn_from_explainer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">quanda.utils.common</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">default_tensor_type</span><span class="p">,</span>
    <span class="n">ds_len</span><span class="p">,</span>
    <span class="n">get_load_state_dict_func</span><span class="p">,</span>
    <span class="n">map_location_context</span><span class="p">,</span>
    <span class="n">process_targets</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">quanda.utils.datasets</span> <span class="kn">import</span> <span class="n">OnDeviceDataset</span>
<span class="kn">from</span> <span class="nn">quanda.utils.functions</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>
<span class="kn">from</span> <span class="nn">quanda.utils.validation</span> <span class="kn">import</span> <span class="n">validate_checkpoints_load_func</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="CaptumInfluence">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumInfluence">[docs]</a>
<span class="k">class</span> <span class="nc">CaptumInfluence</span><span class="p">(</span><span class="n">Explainer</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for the Captum explainers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CaptumInfluence.__init__">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumInfluence.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
        <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">explainer_cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
        <span class="n">explain_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">model_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./cache&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer for the base `CaptumInfluence` wrapper.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : Union[torch.nn.Module, pl.LightningModule]</span>
<span class="sd">            The model to be used for the influence computation.</span>
<span class="sd">        train_dataset : torch.utils.data.Dataset</span>
<span class="sd">            Training dataset to be used for the influence computation.</span>
<span class="sd">        explainer_cls : type</span>
<span class="sd">            The class of the explainer from Captum.</span>
<span class="sd">        explain_kwargs : Any</span>
<span class="sd">            Additional keyword arguments for the explainer.</span>
<span class="sd">        model_id : Optional[str], optional</span>
<span class="sd">            Identifier for the model. Defaults to None.</span>
<span class="sd">        cache_dir : str, optional</span>
<span class="sd">            Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explainer_cls</span> <span class="o">=</span> <span class="n">explainer_cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explain_kwargs</span> <span class="o">=</span> <span class="n">explain_kwargs</span></div>


<div class="viewcode-block" id="CaptumInfluence.init_explainer">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumInfluence.init_explainer">[docs]</a>
    <span class="k">def</span> <span class="nf">init_explainer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">explain_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Captum explainer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **explain_kwargs : Any</span>
<span class="sd">            Additional keyword arguments to be passed to the explainer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer_cls</span><span class="p">(</span><span class="o">**</span><span class="n">explain_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="CaptumInfluence.explain">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumInfluence.explain">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method for computing influence scores for the test samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_tensor : torch.Tensor</span>
<span class="sd">            Test samples for which influence scores are computed.</span>
<span class="sd">        targets : Union[List[int], torch.Tensor], optional</span>
<span class="sd">            Labels for the test samples. Defaults to None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            2D Tensor of shape (test_samples, train_dataset_size) containing the influence scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>
</div>



<div class="viewcode-block" id="CaptumSimilarity">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumSimilarity">[docs]</a>
<span class="k">class</span> <span class="nc">CaptumSimilarity</span><span class="p">(</span><span class="n">CaptumInfluence</span><span class="p">):</span>
    <span class="c1"># TODO: incorporate SimilarityInfluence kwargs into init_kwargs</span>
    <span class="c1"># TODO: Check usage of &#39;replace_nan&#39; in SimilarityInfluence</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for Similarity Influence wrapper. This explainer uses a similarity function on its inputs to rank the training data.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The user is referred to captum&#39;s codebase [1] for details on the specifics of the parameters.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    1) https://captum.ai/api/influence.html#similarityinfluence</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CaptumSimilarity.__init__">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumSimilarity.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
        <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">cache_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./cache&quot;</span><span class="p">,</span>
        <span class="n">similarity_metric</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">,</span>
        <span class="n">similarity_direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">replace_nan</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">load_from_disk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer for the `CaptumSimilarity` explainer.</span>

<span class="sd">        The Captum implementation includes a bug in the batch processing of the dataset, which leads to an error</span>
<span class="sd">        if the dataset size is not divisible by the batch size. To circumvent this issue, we divide the dataset into</span>
<span class="sd">        two subsets and process them separately.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : Union[torch.nn.Module, pl.LightningModule]</span>
<span class="sd">            The model to be used for the influence computation.</span>
<span class="sd">        model_id : str</span>
<span class="sd">            Identifier for the model.</span>
<span class="sd">        train_dataset : torch.utils.data.Dataset</span>
<span class="sd">            Training dataset to be used for the influence computation.</span>
<span class="sd">        layers : Union[str, List[str]]</span>
<span class="sd">            Layers of the model for which the activations are computed.</span>
<span class="sd">        cache_dir : str, optional</span>
<span class="sd">            Directory for caching activations. Defaults to &quot;./cache&quot;.</span>
<span class="sd">        similarity_metric : Callable, optional</span>
<span class="sd">            Metric for computing similarity. Defaults to `cosine_similarity`.</span>
<span class="sd">        similarity_direction : str, optional</span>
<span class="sd">            Direction for similarity computation. Can be either &quot;min&quot; or &quot;max&quot;. Defaults to &quot;max&quot;.</span>
<span class="sd">        batch_size : int, optional</span>
<span class="sd">            Batch size used for iterating over the dataset. Defaults to 1.</span>
<span class="sd">        replace_nan : bool, optional</span>
<span class="sd">            Whether to replace NaN values in similarity scores. Defaults to False.</span>
<span class="sd">        **explainer_kwargs : Any</span>
<span class="sd">            Additional keyword arguments passed to the explainer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing Captum SimilarityInfluence explainer...&quot;</span><span class="p">)</span>

        <span class="c1"># extract and validate layer from kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layers</span>

        <span class="n">model_id</span> <span class="o">+=</span> <span class="s2">&quot;_main&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">explainer_cls</span><span class="o">=</span><span class="n">SimilarityInfluence</span><span class="p">,</span>
            <span class="n">explain_kwargs</span><span class="o">=</span><span class="n">explainer_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">model_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modulo_batch_size</span> <span class="o">=</span> <span class="n">ds_len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span> <span class="o">%</span> <span class="n">batch_size</span>
        <span class="c1"># divide train_dataset into two subsets to make up for a batching bug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_set_1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ds_len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">modulo_batch_size</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;influence_src_dataset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_set_1</span><span class="p">,</span>
                <span class="s2">&quot;activation_dir&quot;</span><span class="p">:</span> <span class="n">cache_dir</span><span class="p">,</span>
                <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="n">model_id</span><span class="p">,</span>
                <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span>
                <span class="s2">&quot;similarity_direction&quot;</span><span class="p">:</span> <span class="n">similarity_direction</span><span class="p">,</span>
                <span class="s2">&quot;similarity_metric&quot;</span><span class="p">:</span> <span class="n">similarity_metric</span><span class="p">,</span>
                <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="s2">&quot;replace_nan&quot;</span><span class="p">:</span> <span class="n">replace_nan</span><span class="p">,</span>
                <span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># As opposed to the original implementation, we move the activation generation to the init method.</span>
        <span class="n">AV</span><span class="o">.</span><span class="n">generate_dataset_activations</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_set_1</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;src&quot;</span><span class="p">,</span>
            <span class="n">load_from_disk</span><span class="o">=</span><span class="n">load_from_disk</span><span class="p">,</span>
            <span class="n">return_activations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer_cls</span><span class="p">(</span><span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">train_set_2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modulo_batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_set_2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Subset</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
                <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ds_len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">modulo_batch_size</span><span class="p">,</span> <span class="n">ds_len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">))],</span>
            <span class="p">)</span>
            <span class="n">explainer_kwargs_2</span> <span class="o">=</span> <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">explainer_kwargs_2</span><span class="p">[</span><span class="s2">&quot;influence_src_dataset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_set_2</span>
            <span class="n">explainer_kwargs_2</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_set_2</span><span class="p">)</span>
            <span class="n">explainer_kwargs_2</span><span class="p">[</span><span class="s2">&quot;model_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_id</span> <span class="o">+</span> <span class="s2">&quot;_suppl_act&quot;</span>

            <span class="n">AV</span><span class="o">.</span><span class="n">generate_dataset_activations</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span> <span class="o">+</span> <span class="s2">&quot;_suppl_act&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_set_2</span><span class="p">,</span> <span class="n">ds_len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_set_2</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="n">identifier</span><span class="o">=</span><span class="s2">&quot;src&quot;</span><span class="p">,</span>
                <span class="n">load_from_disk</span><span class="o">=</span><span class="n">load_from_disk</span><span class="p">,</span>
                <span class="n">return_activations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">explainer_cls</span><span class="p">(</span><span class="o">**</span><span class="n">explainer_kwargs_2</span><span class="p">)</span>

        <span class="c1"># explicitly specifying explain method kwargs as instance attributes</span>

        <span class="k">if</span> <span class="s2">&quot;top_k&quot;</span> <span class="ow">in</span> <span class="n">explainer_kwargs</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;top_k is not supported by CaptumSimilarity explainer. Ignoring the argument.&quot;</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the layer for which the activations are computed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_layer</span>

    <span class="nd">@layer</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Our wrapper only allows a single layer to be passed, while the Captum implementation allows multiple layers.</span>
<span class="sd">        Here, we validate if only a single layer was passed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_layer</span> <span class="o">=</span> <span class="n">layers</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A single layer shall be passed to the CaptumSimilarity explainer.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_layer</span> <span class="o">=</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="CaptumSimilarity.explain">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumSimilarity.explain">[docs]</a>
    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute influence scores for the test samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_tensor : torch.Tensor</span>
<span class="sd">            Test samples for which influence scores are computed.</span>
<span class="sd">        targets : Union[List[int], torch.Tensor], optional</span>
<span class="sd">            Labels for the test samples. This argument is ignored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            2D Tensor of shape (test_samples, train_dataset_size) containing the influence scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_tensor</span> <span class="o">=</span> <span class="n">test_tensor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">map_location_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">default_tensor_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">):</span>
            <span class="n">topk_idx_1</span><span class="p">,</span> <span class="n">topk_val_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer_1</span><span class="o">.</span><span class="n">influence</span><span class="p">(</span>
                <span class="n">inputs</span><span class="o">=</span><span class="n">test_tensor</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">ds_len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">modulo_batch_size</span>
            <span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">modulo_batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">topk_idx_2</span><span class="p">,</span> <span class="n">topk_val_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer_2</span><span class="o">.</span><span class="n">influence</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">test_tensor</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modulo_batch_size</span><span class="p">)[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">layer</span>
                <span class="p">]</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">inverted_idx_1</span> <span class="o">=</span> <span class="n">topk_idx_1</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">inverted_idx_2</span> <span class="o">=</span> <span class="n">topk_idx_2</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">topk_val_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inverted_idx_1</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">topk_val_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inverted_idx_2</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">inverted_idx</span> <span class="o">=</span> <span class="n">topk_idx_1</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">topk_val_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inverted_idx</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="captum_similarity_explain">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.captum_similarity_explain">[docs]</a>
<span class="k">def</span> <span class="nf">captum_similarity_explain</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
    <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">test_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./cache&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functional interface for the `CaptumSimilarity` explainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : Union[torch.nn.Module, pl.LightningModule]</span>
<span class="sd">        The model to be used for the influence computation.</span>
<span class="sd">    model_id : str</span>
<span class="sd">        Identifier for the model.</span>
<span class="sd">    test_tensor : torch.Tensor</span>
<span class="sd">        Test samples for which influence scores are computed.</span>
<span class="sd">    train_dataset : torch.utils.data.Dataset</span>
<span class="sd">        Training dataset to be used for the influence computation.</span>
<span class="sd">    cache_dir : str, optional</span>
<span class="sd">        Directory for caching activations. Defaults to &quot;./cache&quot;.</span>
<span class="sd">    explanation_targets : Union[List[int], torch.Tensor], optional</span>
<span class="sd">        Labels for the test samples. Defaults to None.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Additional keyword arguments passed to the explainer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        2D Tensor of shape (test_samples, train_dataset_size) containing the influence scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">explain_fn_from_explainer</span><span class="p">(</span>
        <span class="n">explainer_cls</span><span class="o">=</span><span class="n">CaptumSimilarity</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
        <span class="n">test_tensor</span><span class="o">=</span><span class="n">test_tensor</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="captum_similarity_self_influence">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.captum_similarity_self_influence">[docs]</a>
<span class="k">def</span> <span class="nf">captum_similarity_self_influence</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
    <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">cache_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./cache&quot;</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functional interface for the self-influence scores using the CaptumSimilarity explainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : Union[torch.nn.Module, pl.LightningModule]</span>
<span class="sd">        The model to be used for the influence computation.</span>
<span class="sd">    model_id : str</span>
<span class="sd">        Identifier for the model.</span>
<span class="sd">    train_dataset : torch.utils.data.Dataset</span>
<span class="sd">        Training dataset to be used for the influence computation.</span>
<span class="sd">    cache_dir : str, optional</span>
<span class="sd">        Directory for caching activations. Defaults to &quot;./cache&quot;.</span>
<span class="sd">    batch_size : int, optional</span>
<span class="sd">        Batch size used for iterating over the dataset. Defaults to 1.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Additional keyword arguments passed to the explainer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        Self-influence scores for each datapoint in train_dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">self_influence_fn_from_explainer</span><span class="p">(</span>
        <span class="n">explainer_cls</span><span class="o">=</span><span class="n">CaptumSimilarity</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">model_id</span><span class="o">=</span><span class="n">model_id</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="CaptumArnoldi">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumArnoldi">[docs]</a>
<span class="k">class</span> <span class="nc">CaptumArnoldi</span><span class="p">(</span><span class="n">CaptumInfluence</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for Arnoldi Influence Function wrapper.</span>
<span class="sd">    This implements the ArnoldiInfluence method of Schioppa et. al. (2022) to compute influence function explanations [2].</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The user is referred to captum&#39;s codebase [3] for details on the specifics of the parameters.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    (1) Schioppa, Andrea, et al. (2022). Scaling up influence functions.</span>
<span class="sd">        Proceedings of the AAAI Conference on Artificial Intelligence. Vol. 36. No. 8.</span>

<span class="sd">    (2) Koh, Pang Wei, and Percy Liang. (2017). &quot;Understanding black-box predictions via influence functions.&quot;</span>
<span class="sd">        International conference on machine learning. PMLR</span>

<span class="sd">    (3) https://github.com/pytorch/captum/blob/master/captum/influence/_core/arnoldi_influence_function.py</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CaptumArnoldi.__init__">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumArnoldi.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
        <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">checkpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">loss_fn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">),</span>
        <span class="n">checkpoints_load_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">hessian_dataset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">test_loss_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_wise_grads_per_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">projection_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">arnoldi_dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">arnoldi_tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-1</span><span class="p">,</span>
        <span class="n">hessian_reg</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">hessian_inverse_tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">projection_on_cpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">show_progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer for CaptumArnoldi explainer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : Union[torch.nn.Module, pl.LightningModule]</span>
<span class="sd">            The model to be used for the influence computation.</span>
<span class="sd">        train_dataset : torch.utils.data.Dataset</span>
<span class="sd">            Training dataset to be used for the influence computation.</span>
<span class="sd">        checkpoint : str</span>
<span class="sd">            Checkpoint file for the model.</span>
<span class="sd">        loss_fn : Union[torch.nn.Module, Callable], optional</span>
<span class="sd">            Loss function which is applied to the model. Required to be a reduction=&#39;none&#39; loss.</span>
<span class="sd">            Defaults to CrossEntropyLoss with reduction=&#39;none&#39;.</span>
<span class="sd">        checkpoints_load_func : Optional[Callable], optional</span>
<span class="sd">            Function to load checkpoints. If None, a default function is used. Defaults to None.</span>
<span class="sd">        layers : Optional[List[str]], optional</span>
<span class="sd">            Layers used to compute the gradients. If None, all layers are used. Defaults to None.</span>
<span class="sd">        batch_size : int, optional</span>
<span class="sd">            Batch size used for iterating over the dataset. Defaults to 1.</span>
<span class="sd">        hessian_dataset : Optional[torch.utils.data.Dataset], optional</span>
<span class="sd">            Dataset for calculating the Hessian. It should be smaller than train_dataset.</span>
<span class="sd">            If None, the entire train_dataset is used. Defaults to None.</span>
<span class="sd">        test_loss_fn : Optional[Union[torch.nn.Module, Callable]], optional</span>
<span class="sd">            Loss function which is used for the test samples. If None, loss_fn is used. Defaults to None.</span>
<span class="sd">        projection_dim : int, optional</span>
<span class="sd">            Captum&#39;s ArnoldiInfluenceFunction produces a low-rank approximation of the (inverse) Hessian.</span>
<span class="sd">            projection_dim is the rank of that approximation. Defaults to 50.</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            Random seed for reproducibility. Defaults to 0.</span>
<span class="sd">        arnoldi_dim : int, optional</span>
<span class="sd">            Calculating the low-rank approximation of the (inverse) Hessian requires approximating</span>
<span class="sd">            the Hessian&#39;s top eigenvectors / eigenvalues.</span>
<span class="sd">            This is done by first computing a Krylov subspace via the Arnoldi iteration,</span>
<span class="sd">            and then finding the top eigenvectors / eigenvalues of the restriction of the Hessian to the Krylov subspace.</span>
<span class="sd">            Because only the top eigenvectors / eigenvalues computed in the restriction will be similar to</span>
<span class="sd">            those in the full space, `arnoldi_dim` should be chosen to be larger than `projection_dim`.</span>
<span class="sd">            Defaults to 200.</span>
<span class="sd">        arnoldi_tol : float, optional</span>
<span class="sd">            After many iterations, the already-obtained basis vectors may already approximately span the Krylov subspace,</span>
<span class="sd">            in which case the addition of additional basis vectors involves normalizing a vector with a small norm.</span>
<span class="sd">            These vectors are not necessary to include in the basis and furthermore,</span>
<span class="sd">            their small norm leads to numerical issues.</span>
<span class="sd">            Therefore we stop the Arnoldi iteration when the addition of additional</span>
<span class="sd">            vectors involves normalizing a vector with norm below a certain threshold.</span>
<span class="sd">            This argument specifies that threshold. Defaults to 1e-1.</span>
<span class="sd">        hessian_reg : float, optional</span>
<span class="sd">            After computing the basis for the Krylov subspace, the restriction of the Hessian to the</span>
<span class="sd">            subspace may not be positive definite, which is required, as we compute a low-rank approximation</span>
<span class="sd">            of its square root via eigen-decomposition. `hessian_reg` adds an entry to the diagonals of the</span>
<span class="sd">            restriction of the Hessian to encourage it to be positive definite. This argument specifies that entry.</span>
<span class="sd">            Note that the regularized Hessian (i.e. with `hessian_reg` added to its diagonals) does not actually need</span>
<span class="sd">            to be positive definite - it just needs to have at least 1 positive eigenvalue.</span>
<span class="sd">            Defaults to 1e-3.</span>
<span class="sd">        hessian_inverse_tol : float, optional</span>
<span class="sd">            The tolerance to use when computing the pseudo-inverse of the (square root of) hessian,</span>
<span class="sd">            restricted to the Krylov subspace. Defaults to 1e-4.</span>
<span class="sd">        projection_on_cpu : bool, optional</span>
<span class="sd">            Whether to move the projection, i.e. low-rank approximation of the inverse Hessian, to cpu, to save gpu memory.</span>
<span class="sd">            Defaults to True.</span>
<span class="sd">        show_progress : bool, optional</span>
<span class="sd">            Whether to display a progress bar. Defaults to False.</span>
<span class="sd">        model_id : Optional[str], optional</span>
<span class="sd">            Identifier for the model. Defaults to None.</span>
<span class="sd">        cache_dir : str, optional</span>
<span class="sd">            Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">        device : Union[str, torch.device], optional</span>
<span class="sd">            Device to run the computation on. Defaults to &quot;cpu&quot;.</span>
<span class="sd">        **explainer_kwargs : Any</span>
<span class="sd">            Additional keyword arguments passed to the explainer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing Captum ArnoldiInfluence explainer...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">checkpoints_load_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">checkpoints_load_func</span> <span class="o">=</span> <span class="n">get_load_state_dict_func</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">validate_checkpoints_load_func</span><span class="p">(</span><span class="n">checkpoints_load_func</span><span class="p">)</span>

        <span class="n">unsupported_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;proponents&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">unsupported_args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">explainer_kwargs</span><span class="p">:</span>
                <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2"> is not supported by CaptumArnoldi explainer. Ignoring the argument.&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">explainer_cls</span><span class="o">=</span><span class="n">ArnoldiInfluenceFunction</span><span class="p">,</span>
            <span class="n">explain_kwargs</span><span class="o">=</span><span class="n">explainer_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hessian_dataset</span> <span class="o">=</span> <span class="n">OnDeviceDataset</span><span class="p">(</span><span class="n">hessian_dataset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">if</span> <span class="n">hessian_dataset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;train_dataset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
                <span class="s2">&quot;checkpoint&quot;</span><span class="p">:</span> <span class="n">checkpoint</span><span class="p">,</span>
                <span class="s2">&quot;checkpoints_load_func&quot;</span><span class="p">:</span> <span class="n">checkpoints_load_func</span><span class="p">,</span>
                <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="p">,</span>
                <span class="s2">&quot;loss_fn&quot;</span><span class="p">:</span> <span class="n">loss_fn</span><span class="p">,</span>
                <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="s2">&quot;hessian_dataset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian_dataset</span><span class="p">,</span>
                <span class="s2">&quot;test_loss_fn&quot;</span><span class="p">:</span> <span class="n">test_loss_fn</span><span class="p">,</span>
                <span class="s2">&quot;sample_wise_grads_per_batch&quot;</span><span class="p">:</span> <span class="n">sample_wise_grads_per_batch</span><span class="p">,</span>
                <span class="s2">&quot;projection_dim&quot;</span><span class="p">:</span> <span class="n">projection_dim</span><span class="p">,</span>
                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span>
                <span class="s2">&quot;arnoldi_dim&quot;</span><span class="p">:</span> <span class="n">arnoldi_dim</span><span class="p">,</span>
                <span class="s2">&quot;arnoldi_tol&quot;</span><span class="p">:</span> <span class="n">arnoldi_tol</span><span class="p">,</span>
                <span class="s2">&quot;hessian_reg&quot;</span><span class="p">:</span> <span class="n">hessian_reg</span><span class="p">,</span>
                <span class="s2">&quot;hessian_inverse_tol&quot;</span><span class="p">:</span> <span class="n">hessian_inverse_tol</span><span class="p">,</span>
                <span class="s2">&quot;projection_on_cpu&quot;</span><span class="p">:</span> <span class="n">projection_on_cpu</span><span class="p">,</span>
                <span class="s2">&quot;show_progress&quot;</span><span class="p">:</span> <span class="n">show_progress</span><span class="p">,</span>
                <span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_explainer</span><span class="p">(</span><span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="CaptumArnoldi.explain">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumArnoldi.explain">[docs]</a>
    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute influence scores for the test samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_tensor : torch.Tensor</span>
<span class="sd">            Test samples for which influence scores are computed.</span>
<span class="sd">        targets : Union[List[int], torch.Tensor]</span>
<span class="sd">            Labels for the test samples. This argument is required.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            2D Tensor of shape (test_samples, train_dataset_size) containing the influence scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_tensor</span> <span class="o">=</span> <span class="n">test_tensor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">process_targets</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">influence_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer</span><span class="o">.</span><span class="n">influence</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">(</span><span class="n">test_tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">influence_scores</span></div>


<div class="viewcode-block" id="CaptumArnoldi.self_influence">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumArnoldi.self_influence">[docs]</a>
    <span class="k">def</span> <span class="nf">self_influence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute self-influence scores.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        batch_size : int, optional</span>
<span class="sd">            Batch size used for iterating over the dataset. This argument is ignored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Self-influence scores for each datapoint in train_dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">influence_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer</span><span class="o">.</span><span class="n">self_influence</span><span class="p">(</span><span class="n">inputs_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">influence_scores</span></div>
</div>



<div class="viewcode-block" id="captum_arnoldi_explain">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.captum_arnoldi_explain">[docs]</a>
<span class="k">def</span> <span class="nf">captum_arnoldi_explain</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
    <span class="n">test_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">explanation_targets</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functional interface for the `CaptumArnoldi` explainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : Union[torch.nn.Module, pl.LightningModule]</span>
<span class="sd">        The model to be used for the influence computation.</span>
<span class="sd">    test_tensor : torch.Tensor</span>
<span class="sd">        Test samples for which influence scores are computed.</span>
<span class="sd">    explanation_targets : Union[List[int], torch.Tensor]</span>
<span class="sd">        Labels for the test samples.</span>
<span class="sd">    train_dataset : torch.utils.data.Dataset</span>
<span class="sd">        Training dataset to be used for the influence computation.</span>
<span class="sd">    model_id : Optional[str], optional</span>
<span class="sd">        Identifier for the model. Defaults to None.</span>
<span class="sd">    cache_dir : str, optional</span>
<span class="sd">        Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Additional keyword arguments passed to the explainer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        2D Tensor of shape (test_samples, train_dataset_size) containing the influence scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">explain_fn_from_explainer</span><span class="p">(</span>
        <span class="n">explainer_cls</span><span class="o">=</span><span class="n">CaptumArnoldi</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">test_tensor</span><span class="o">=</span><span class="n">test_tensor</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="n">explanation_targets</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="captum_arnoldi_self_influence">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.captum_arnoldi_self_influence">[docs]</a>
<span class="k">def</span> <span class="nf">captum_arnoldi_self_influence</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functional interface for the self-influence scores using the `CaptumArnoldi` explainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : torch.nn.Module</span>
<span class="sd">        The model to be used for the influence computation.</span>
<span class="sd">    train_dataset : torch.utils.data.Dataset</span>
<span class="sd">        Training dataset to be used for the influence computation.</span>
<span class="sd">    model_id : Optional[str], optional</span>
<span class="sd">        Identifier for the model. Defaults to None.</span>
<span class="sd">    cache_dir : str, optional</span>
<span class="sd">        Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Additional keyword arguments passed to the explainer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        Self-influence scores for each datapoint in train_dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">self_influence_fn_from_explainer</span><span class="p">(</span>
        <span class="n">explainer_cls</span><span class="o">=</span><span class="n">CaptumArnoldi</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="CaptumTracInCP">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumTracInCP">[docs]</a>
<span class="k">class</span> <span class="nc">CaptumTracInCP</span><span class="p">(</span><span class="n">CaptumInfluence</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for the captum TracInCP explainer. This implements the TracIn method as described by Pruthi et al. (2020).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The user is referred to captum&#39;s codebase [2] for details on the specifics of the parameters.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    (1) Pruthi, Garima, et al. (2020). Estimating training data influence by tracing gradient descent.</span>
<span class="sd">        Advances in Neural Information Processing Systems 33. (19920-19930).</span>

<span class="sd">    (2) https://github.com/pytorch/captum/blob/master/captum/influence/_core/tracincp.py</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CaptumTracInCP.__init__">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumTracInCP.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
        <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">checkpoints</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Iterator</span><span class="p">],</span>
        <span class="n">checkpoints_load_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">layers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loss_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">test_loss_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_wise_grads_per_batch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializer for the `CaptumTracInCP` explainer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : Union[torch.nn.Module, pl.LightningModule]</span>
<span class="sd">            The model to be used for the influence computation.</span>
<span class="sd">        train_dataset : torch.utils.data.Dataset</span>
<span class="sd">            Training dataset to be used for the influence computation.</span>
<span class="sd">        checkpoints : Union[str, List[str], Iterator]</span>
<span class="sd">            Checkpoints for the model.</span>
<span class="sd">        checkpoints_load_func : Optional[Callable], optional</span>
<span class="sd">            Function to load checkpoints. If None, a default function is used. Defaults to None.</span>
<span class="sd">        layers : Optional[List[str]], optional</span>
<span class="sd">            Layers used to compute the gradients. Defaults to None.</span>
<span class="sd">        loss_fn : Optional[Union[torch.nn.Module, Callable]], optional</span>
<span class="sd">            Loss function used for influence computation. Defaults to CrossEntropyLoss with reduction=&#39;sum&#39;.</span>
<span class="sd">        batch_size : int, optional</span>
<span class="sd">            Batch size used for iterating over the dataset. Defaults to 1.</span>
<span class="sd">        test_loss_fn : Optional[Union[torch.nn.Module, Callable]], optional</span>
<span class="sd">            Loss function which is used for the test samples. If None, loss_fn is used. Defaults to None.</span>
<span class="sd">        model_id : Optional[str], optional</span>
<span class="sd">            Identifier for the model. Defaults to None.</span>
<span class="sd">        cache_dir : str, optional</span>
<span class="sd">            Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">        device : Union[str, torch.device], optional</span>
<span class="sd">            Device to run the computation on. Defaults to &quot;cpu&quot;.</span>
<span class="sd">        **explainer_kwargs : Any</span>
<span class="sd">            Additional keyword arguments passed to the explainer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing Captum TracInCP explainer...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">checkpoints_load_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">checkpoints_load_func</span> <span class="o">=</span> <span class="n">get_load_state_dict_func</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">validate_checkpoints_load_func</span><span class="p">(</span><span class="n">checkpoints_load_func</span><span class="p">)</span>

        <span class="n">unsupported_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;proponents&quot;</span><span class="p">,</span> <span class="s2">&quot;aggregate&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">unsupported_args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">explainer_kwargs</span><span class="p">:</span>
                <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2"> is not supported by CaptumTraceInCP explainer. Ignoring the argument.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outer_loop_by_checkpoints</span> <span class="o">=</span> <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;outer_loop_by_checkpoints&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">explainer_cls</span><span class="o">=</span><span class="n">TracInCP</span><span class="p">,</span>
            <span class="n">explain_kwargs</span><span class="o">=</span><span class="n">explainer_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;train_dataset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
                <span class="s2">&quot;checkpoints&quot;</span><span class="p">:</span> <span class="n">checkpoints</span><span class="p">,</span>
                <span class="s2">&quot;checkpoints_load_func&quot;</span><span class="p">:</span> <span class="n">checkpoints_load_func</span><span class="p">,</span>
                <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="p">,</span>
                <span class="s2">&quot;loss_fn&quot;</span><span class="p">:</span> <span class="n">loss_fn</span><span class="p">,</span>
                <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="s2">&quot;test_loss_fn&quot;</span><span class="p">:</span> <span class="n">test_loss_fn</span><span class="p">,</span>
                <span class="s2">&quot;sample_wise_grads_per_batch&quot;</span><span class="p">:</span> <span class="n">sample_wise_grads_per_batch</span><span class="p">,</span>
                <span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_explainer</span><span class="p">(</span><span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span></div>


<div class="viewcode-block" id="CaptumTracInCP.explain">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumTracInCP.explain">[docs]</a>
    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute influence scores for the test samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_tensor : torch.Tensor</span>
<span class="sd">            Test samples for which influence scores are computed.</span>
<span class="sd">        targets : Union[List[int], torch.Tensor]</span>
<span class="sd">            Labels for the test samples. This argument is required.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            2D Tensor of shape (test_samples, train_dataset_size) containing the influence scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_tensor</span> <span class="o">=</span> <span class="n">test_tensor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">process_targets</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">influence_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer</span><span class="o">.</span><span class="n">influence</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">(</span><span class="n">test_tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">influence_scores</span></div>


<div class="viewcode-block" id="CaptumTracInCP.self_influence">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumTracInCP.self_influence">[docs]</a>
    <span class="k">def</span> <span class="nf">self_influence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute self-influence scores.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        batch_size : int, optional</span>
<span class="sd">            Batch size used for iterating over the dataset. This argument is ignored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Self-influence scores for each datapoint in train_dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">influence_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer</span><span class="o">.</span><span class="n">self_influence</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outer_loop_by_checkpoints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_loop_by_checkpoints</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">influence_scores</span></div>
</div>



<div class="viewcode-block" id="captum_tracincp_explain">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.captum_tracincp_explain">[docs]</a>
<span class="k">def</span> <span class="nf">captum_tracincp_explain</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
    <span class="n">test_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">explanation_targets</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functional interface for the `CaptumTracInCP` explainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : Union[torch.nn.Module, pl.LightningModule]</span>
<span class="sd">        The model to be used for the influence computation.</span>
<span class="sd">    test_tensor : torch.Tensor</span>
<span class="sd">        Test samples for which influence scores are computed.</span>
<span class="sd">    explanation_targets : Union[List[int], torch.Tensor]</span>
<span class="sd">        Labels for the test samples.</span>
<span class="sd">    train_dataset : torch.utils.data.Dataset</span>
<span class="sd">        Training dataset to be used for the influence computation.</span>
<span class="sd">    model_id : Optional[str], optional</span>
<span class="sd">        Identifier for the model. Defaults to None.</span>
<span class="sd">    cache_dir : str, optional</span>
<span class="sd">        Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Additional keyword arguments passed to the explainer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        2D Tensor of shape (test_samples, train_dataset_size) containing the influence scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">explain_fn_from_explainer</span><span class="p">(</span>
        <span class="n">explainer_cls</span><span class="o">=</span><span class="n">CaptumTracInCP</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">test_tensor</span><span class="o">=</span><span class="n">test_tensor</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="n">explanation_targets</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="captum_tracincp_self_influence">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.captum_tracincp_self_influence">[docs]</a>
<span class="k">def</span> <span class="nf">captum_tracincp_self_influence</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functional interface for the self-influence scores using the `CaptumTracInCP` explainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : Union[torch.nn.Module, pl.LightningModule]</span>
<span class="sd">        The model to be used for the influence computation.</span>
<span class="sd">    train_dataset : torch.utils.data.Dataset</span>
<span class="sd">        Training dataset to be used for the influence computation.</span>
<span class="sd">    model_id : Optional[str], optional</span>
<span class="sd">        Identifier for the model. Defaults to None.</span>
<span class="sd">    cache_dir : str, optional</span>
<span class="sd">        Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Additional keyword arguments passed to the explainer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        Self-influence scores for each datapoint in train_dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">self_influence_fn_from_explainer</span><span class="p">(</span>
        <span class="n">explainer_cls</span><span class="o">=</span><span class="n">CaptumTracInCP</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="CaptumTracInCPFast">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumTracInCPFast">[docs]</a>
<span class="k">class</span> <span class="nc">CaptumTracInCPFast</span><span class="p">(</span><span class="n">CaptumInfluence</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for the captum TracInCPFast explainer.</span>
<span class="sd">    This implements the TracIn method by Pruthi et al. (2020) using only the final layer parameters.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The user is referred to captum&#39;s codebase [2] for details on the specifics of the parameters.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    (1) Pruthi, Garima, et al. (2020). &quot;Estimating training data influence by tracing gradient descent.&quot;</span>
<span class="sd">        Advances in Neural Information Processing Systems 33. (19920-19930).</span>

<span class="sd">    (2) https://github.com/pytorch/captum/blob/master/captum/influence/_core/tracincp_fast_rand_proj.py</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CaptumTracInCPFast.__init__">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumTracInCPFast.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">final_fc_layer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">checkpoints</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Iterator</span><span class="p">],</span>
        <span class="n">checkpoints_load_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loss_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">test_loss_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">vectorize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializer for the `CaptumTracInCPFast` explainer.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : torch.nn.Module</span>
<span class="sd">            The model to be used for the influence computation.</span>
<span class="sd">        final_fc_layer : torch.nn.Module</span>
<span class="sd">            Final fully connected layer of the model.</span>
<span class="sd">        train_dataset : torch.utils.data.Dataset</span>
<span class="sd">            Training dataset to be used for the influence computation.</span>
<span class="sd">        checkpoints : Union[str, List[str], Iterator]</span>
<span class="sd">            Checkpoints for the model.</span>
<span class="sd">        model_id : Optional[str], optional</span>
<span class="sd">            Identifier for the model. Defaults to None.</span>
<span class="sd">        cache_dir : str, optional</span>
<span class="sd">            Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">        checkpoints_load_func : Optional[Callable[..., Any]], optional</span>
<span class="sd">            Function to load checkpoints. If None, a default function is used.</span>
<span class="sd">        loss_fn : Optional[Union[torch.nn.Module, Callable]], optional</span>
<span class="sd">            Loss function used for influence computation. Defaults to `CrossEntropyLoss` with `reduction=&#39;sum&#39;`.</span>
<span class="sd">        batch_size : int, optional</span>
<span class="sd">            Batch size used for iterating over the dataset. Defaults to 1.</span>
<span class="sd">        test_loss_fn : Optional[Union[torch.nn.Module, Callable]], optional</span>
<span class="sd">            Loss function which is used for the test samples. If None, loss_fn is used. Defaults to None.</span>
<span class="sd">        vectorize : bool, optional</span>
<span class="sd">            Whether to use experimental vectorize functionality for `torch.autograd.functional.jacobian`. Defaults to False.</span>
<span class="sd">        device : Union[str, torch.device], optional</span>
<span class="sd">            Device to run the computation on. Defaults to &quot;cpu&quot;.</span>
<span class="sd">        **explainer_kwargs : Any</span>
<span class="sd">            Additional keyword arguments passed to the explainer.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing Captum TracInCPFast explainer...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">checkpoints_load_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">checkpoints_load_func</span> <span class="o">=</span> <span class="n">get_load_state_dict_func</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">validate_checkpoints_load_func</span><span class="p">(</span><span class="n">checkpoints_load_func</span><span class="p">)</span>

        <span class="n">unsupported_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;proponents&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">unsupported_args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">explainer_kwargs</span><span class="p">:</span>
                <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2"> is not supported by CaptumTraceInCPFast explainer. Ignoring the argument.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outer_loop_by_checkpoints</span> <span class="o">=</span> <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;outer_loop_by_checkpoints&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">explainer_cls</span><span class="o">=</span><span class="n">TracInCPFast</span><span class="p">,</span>
            <span class="n">explain_kwargs</span><span class="o">=</span><span class="n">explainer_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;final_fc_layer&quot;</span><span class="p">:</span> <span class="n">final_fc_layer</span><span class="p">,</span>
                <span class="s2">&quot;train_dataset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
                <span class="s2">&quot;checkpoints&quot;</span><span class="p">:</span> <span class="n">checkpoints</span><span class="p">,</span>
                <span class="s2">&quot;checkpoints_load_func&quot;</span><span class="p">:</span> <span class="n">checkpoints_load_func</span><span class="p">,</span>
                <span class="s2">&quot;loss_fn&quot;</span><span class="p">:</span> <span class="n">loss_fn</span><span class="p">,</span>
                <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="s2">&quot;test_loss_fn&quot;</span><span class="p">:</span> <span class="n">test_loss_fn</span><span class="p">,</span>
                <span class="s2">&quot;vectorize&quot;</span><span class="p">:</span> <span class="n">vectorize</span><span class="p">,</span>
                <span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_explainer</span><span class="p">(</span><span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="CaptumTracInCPFast.explain">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumTracInCPFast.explain">[docs]</a>
    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute influence scores for the test samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_tensor : torch.Tensor</span>
<span class="sd">            Test samples for which influence scores are computed.</span>
<span class="sd">        targets : Union[List[int], torch.Tensor]</span>
<span class="sd">            Labels for the test samples. This argument is required.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            2D Tensor of shape (test_samples, train_dataset_size) containing the influence scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_tensor</span> <span class="o">=</span> <span class="n">test_tensor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">process_targets</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">influence_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer</span><span class="o">.</span><span class="n">influence</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">(</span><span class="n">test_tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">influence_scores</span></div>


<div class="viewcode-block" id="CaptumTracInCPFast.self_influence">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumTracInCPFast.self_influence">[docs]</a>
    <span class="k">def</span> <span class="nf">self_influence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute self-influence scores.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        batch_size : int, optional</span>
<span class="sd">            Batch size used for iterating over the dataset. This argument is ignored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            Self-influence scores for each datapoint in train_dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">influence_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer</span><span class="o">.</span><span class="n">self_influence</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outer_loop_by_checkpoints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_loop_by_checkpoints</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">influence_scores</span></div>
</div>



<div class="viewcode-block" id="captum_tracincp_fast_explain">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.captum_tracincp_fast_explain">[docs]</a>
<span class="k">def</span> <span class="nf">captum_tracincp_fast_explain</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
    <span class="n">test_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">explanation_targets</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functional interface for the `CaptumTracInCPFast` explainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : torch.nn.Module</span>
<span class="sd">        The model to be used for the influence computation.</span>
<span class="sd">    test_tensor : torch.Tensor</span>
<span class="sd">        Test samples for which influence scores are computed.</span>
<span class="sd">    explanation_targets : Union[List[int], torch.Tensor]</span>
<span class="sd">        Labels for the test samples.</span>
<span class="sd">    train_dataset : torch.utils.data.Dataset</span>
<span class="sd">        Training dataset to be used for the influence computation.</span>
<span class="sd">    model_id : Optional[str], optional</span>
<span class="sd">        Identifier for the model. Defaults to None.</span>
<span class="sd">    cache_dir : str, optional</span>
<span class="sd">        Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Additional keyword arguments passed to the explainer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        2D Tensor of shape (test_samples, train_dataset_size) containing the influence scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">explain_fn_from_explainer</span><span class="p">(</span>
        <span class="n">explainer_cls</span><span class="o">=</span><span class="n">CaptumTracInCPFast</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">test_tensor</span><span class="o">=</span><span class="n">test_tensor</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="n">explanation_targets</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="captum_tracincp_fast_self_influence">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.captum_tracincp_fast_self_influence">[docs]</a>
<span class="k">def</span> <span class="nf">captum_tracincp_fast_self_influence</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">outer_loop_by_checkpoints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functional interface for the self-influence scores using the `CaptumTracInCPFast` explainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : torch.nn.Module</span>
<span class="sd">        The model to be used for the influence computation.</span>
<span class="sd">    train_dataset : torch.utils.data.Dataset</span>
<span class="sd">        Training dataset to be used for the influence computation.</span>
<span class="sd">    model_id : Optional[str], optional</span>
<span class="sd">        Identifier for the model. Defaults to None.</span>
<span class="sd">    cache_dir : str, optional</span>
<span class="sd">        Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">    outer_loop_by_checkpoints : bool, optional</span>
<span class="sd">        Whether to perform an outer loop over the checkpoints. Defaults to False.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Additional keyword arguments passed to the explainer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        Self-influence scores for each datapoint in train_dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">self_influence_fn_from_explainer</span><span class="p">(</span>
        <span class="n">explainer_cls</span><span class="o">=</span><span class="n">CaptumTracInCPFast</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="n">outer_loop_by_checkpoints</span><span class="o">=</span><span class="n">outer_loop_by_checkpoints</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="CaptumTracInCPFastRandProj">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumTracInCPFastRandProj">[docs]</a>
<span class="k">class</span> <span class="nc">CaptumTracInCPFastRandProj</span><span class="p">(</span><span class="n">CaptumInfluence</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper for the captum TracInCPFastRandProj explainer.</span>
<span class="sd">    This implements the TracIn method by Pruthi et al. (2020) using only the final layer parameters</span>
<span class="sd">    and random projections to speed up computation.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The user is referred to captum&#39;s codebase [2] for details on the specifics of the parameters.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    (1) Pruthi, Garima, et al. (2020). &quot;Estimating training data influence by tracing gradient descent.&quot;</span>
<span class="sd">        Advances in Neural Information Processing Systems 33. (19920-19930).</span>

<span class="sd">    (2) https://github.com/pytorch/captum/blob/master/captum/influence/_core/tracincp_fast_rand_proj.py</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CaptumTracInCPFastRandProj.__init__">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumTracInCPFastRandProj.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
        <span class="n">final_fc_layer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">checkpoints</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Iterator</span><span class="p">],</span>
        <span class="n">checkpoints_load_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loss_fn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">test_loss_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">vectorize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">nearest_neighbors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NearestNeighbors</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">projection_dim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializer for the `CaptumTracInCPFastRandProj` explainer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : Union[torch.nn.Module, pl.LightningModule]</span>
<span class="sd">            The model to be used for the influence computation.</span>
<span class="sd">        final_fc_layer : torch.nn.Module</span>
<span class="sd">            Final fully connected layer of the model.</span>
<span class="sd">        train_dataset : torch.utils.data.Dataset</span>
<span class="sd">            Training dataset to be used for the influence computation.</span>
<span class="sd">        checkpoints : Union[str, List[str], Iterator]</span>
<span class="sd">            Checkpoints for the model.</span>
<span class="sd">        model_id : Optional[str], optional</span>
<span class="sd">            Identifier for the model. Defaults to None.</span>
<span class="sd">        cache_dir : str, optional</span>
<span class="sd">            Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">        checkpoints_load_func : Optional[Callable[..., Any]], optional</span>
<span class="sd">            Function to load checkpoints. If None, a default function is used.</span>
<span class="sd">        loss_fn : Union[torch.nn.Module, Callable], optional</span>
<span class="sd">            Loss function used for influence computation. Defaults to `CrossEntropyLoss` with `reduction=&#39;sum&#39;`.</span>
<span class="sd">        batch_size : int, optional</span>
<span class="sd">            Batch size used for iterating over the dataset. Defaults to 1.</span>
<span class="sd">        test_loss_fn : Optional[Union[torch.nn.Module, Callable]], optional</span>
<span class="sd">            Loss function which is used for the test samples. If None, loss_fn is used. Defaults to None.</span>
<span class="sd">        vectorize : bool, optional</span>
<span class="sd">            Whether to use experimental vectorize functionality for `torch.autograd.functional.jacobian`. Defaults to False.</span>
<span class="sd">        nearest_neighbors : Optional[NearestNeighbors], optional</span>
<span class="sd">            Nearest neighbors model for finding nearest neighbors. If None, defaults to AnnoyNearestNeighbors is used.</span>
<span class="sd">        projection_dim : Optional[int], optional</span>
<span class="sd">            Each example will be represented in</span>
<span class="sd">            the nearest neighbors data structure with a vector. This vector</span>
<span class="sd">            is the concatenation of several &quot;checkpoint vectors&quot;, each of which</span>
<span class="sd">            is computed using a different checkpoint in the `checkpoints`</span>
<span class="sd">            argument. If `projection_dim` is an int, it represents the</span>
<span class="sd">            dimension we will project each &quot;checkpoint vector&quot; to, so that the</span>
<span class="sd">            vector for each example will be of dimension at most</span>
<span class="sd">            `projection_dim` * C, where C is the number of checkpoints.</span>
<span class="sd">            Regarding the dimension of each vector, D: Let I be the dimension</span>
<span class="sd">            of the output of the last fully-connected layer times the dimension</span>
<span class="sd">            of the input of the last fully-connected layer. If `projection_dim`</span>
<span class="sd">            is not `None`, then D = min(I * C, `projection_dim` * C).</span>
<span class="sd">            Otherwise, D = I * C. In summary, if `projection_dim` is None, the</span>
<span class="sd">            dimension of this vector will be determined by the size of the</span>
<span class="sd">            input and output of the last fully-connected layer of `model`, and</span>
<span class="sd">            the number of checkpoints. Otherwise, `projection_dim` must be an</span>
<span class="sd">            int, and random projection will be performed to ensure that the</span>
<span class="sd">            vector is of dimension no more than `projection_dim` * C.</span>
<span class="sd">            `projection_dim` corresponds to the variable d in the top of page</span>
<span class="sd">            5 of the TracIn paper (Reference 1).</span>
<span class="sd">        seed : int, optional</span>
<span class="sd">            Random seed for reproducibility. Defaults to 0.</span>
<span class="sd">        device : Union[str, torch.device], optional</span>
<span class="sd">            Device to run the computation on. Defaults to &quot;cpu&quot;.</span>
<span class="sd">        **explainer_kwargs : Any</span>
<span class="sd">            Additional keyword arguments passed to the explainer.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing Captum TracInCPFastRandProj explainer...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">checkpoints_load_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">checkpoints_load_func</span> <span class="o">=</span> <span class="n">get_load_state_dict_func</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">validate_checkpoints_load_func</span><span class="p">(</span><span class="n">checkpoints_load_func</span><span class="p">)</span>

        <span class="n">unsupported_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;proponents&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">unsupported_args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">explainer_kwargs</span><span class="p">:</span>
                <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2"> is not supported by CaptumTraceInCPFastRandProj explainer. Ignoring the argument.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outer_loop_by_checkpoints</span> <span class="o">=</span> <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;outer_loop_by_checkpoints&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">explainer_cls</span><span class="o">=</span><span class="n">TracInCPFastRandProj</span><span class="p">,</span>
            <span class="n">explain_kwargs</span><span class="o">=</span><span class="n">explainer_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">explainer_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;final_fc_layer&quot;</span><span class="p">:</span> <span class="n">final_fc_layer</span><span class="p">,</span>
                <span class="s2">&quot;train_dataset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset</span><span class="p">,</span>
                <span class="s2">&quot;checkpoints&quot;</span><span class="p">:</span> <span class="n">checkpoints</span><span class="p">,</span>
                <span class="s2">&quot;checkpoints_load_func&quot;</span><span class="p">:</span> <span class="n">checkpoints_load_func</span><span class="p">,</span>
                <span class="s2">&quot;loss_fn&quot;</span><span class="p">:</span> <span class="n">loss_fn</span><span class="p">,</span>
                <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
                <span class="s2">&quot;test_loss_fn&quot;</span><span class="p">:</span> <span class="n">test_loss_fn</span><span class="p">,</span>
                <span class="s2">&quot;vectorize&quot;</span><span class="p">:</span> <span class="n">vectorize</span><span class="p">,</span>
                <span class="s2">&quot;nearest_neighbors&quot;</span><span class="p">:</span> <span class="n">nearest_neighbors</span><span class="p">,</span>
                <span class="s2">&quot;projection_dim&quot;</span><span class="p">:</span> <span class="n">projection_dim</span><span class="p">,</span>
                <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">seed</span><span class="p">,</span>
                <span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_explainer</span><span class="p">(</span><span class="o">**</span><span class="n">explainer_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="CaptumTracInCPFastRandProj.explain">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.CaptumTracInCPFastRandProj.explain">[docs]</a>
    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute influence scores for the test samples.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_tensor : torch.Tensor</span>
<span class="sd">            Test samples for which influence scores are computed.</span>
<span class="sd">        targets : Union[List[int], torch.Tensor]</span>
<span class="sd">            Labels for the test samples. This argument is required.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        torch.Tensor</span>
<span class="sd">            2D Tensor of shape (test_samples, train_dataset_size) containing the influence scores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_tensor</span> <span class="o">=</span> <span class="n">test_tensor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">process_targets</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">influence_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captum_explainer</span><span class="o">.</span><span class="n">influence</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">(</span><span class="n">test_tensor</span><span class="p">,</span> <span class="n">targets</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">influence_scores</span></div>
</div>



<div class="viewcode-block" id="captum_tracincp_fast_rand_proj_explain">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.captum_tracincp_fast_rand_proj_explain">[docs]</a>
<span class="k">def</span> <span class="nf">captum_tracincp_fast_rand_proj_explain</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
    <span class="n">test_tensor</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="n">explanation_targets</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functional interface for the `CaptumTracInCPFastRandProj` explainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : Union[torch.nn.Module, pl.LightningModule]</span>
<span class="sd">        The model to be used for the influence computation.</span>
<span class="sd">    test_tensor : torch.Tensor</span>
<span class="sd">        Test samples for which influence scores are computed.</span>
<span class="sd">    train_dataset : torch.utils.data.Dataset</span>
<span class="sd">        Training dataset to be used for the influence computation.</span>
<span class="sd">    explanation_targets : Union[List[int], torch.Tensor]</span>
<span class="sd">        Labels for the test samples.</span>
<span class="sd">    model_id : Optional[str], optional</span>
<span class="sd">        Identifier for the model. Defaults to None.</span>
<span class="sd">    cache_dir : str, optional</span>
<span class="sd">        Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Additional keyword arguments passed to the explainer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        2D Tensor of shape (test_samples, train_dataset_size) containing the influence scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">explain_fn_from_explainer</span><span class="p">(</span>
        <span class="n">explainer_cls</span><span class="o">=</span><span class="n">CaptumTracInCPFastRandProj</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">test_tensor</span><span class="o">=</span><span class="n">test_tensor</span><span class="p">,</span>
        <span class="n">targets</span><span class="o">=</span><span class="n">explanation_targets</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="captum_tracincp_fast_rand_proj_self_influence">
<a class="viewcode-back" href="../../../../docs_api/quanda.explainers.wrappers.captum_influence.html#quanda.explainers.wrappers.captum_tracincp_fast_rand_proj_self_influence">[docs]</a>
<span class="k">def</span> <span class="nf">captum_tracincp_fast_rand_proj_self_influence</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">outer_loop_by_checkpoints</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Functional interface for the self-influence scores using the `CaptumTracInCPFastRandProj` explainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : torch.nn.Module</span>
<span class="sd">        The model to be used for the influence computation.</span>
<span class="sd">    train_dataset : torch.utils.data.Dataset</span>
<span class="sd">        Training dataset to be used for the influence computation.</span>
<span class="sd">    model_id : Optional[str], optional</span>
<span class="sd">        Identifier for the model. Defaults to None.</span>
<span class="sd">    cache_dir : str, optional</span>
<span class="sd">        Directory for caching results. Defaults to &quot;./cache&quot;.</span>
<span class="sd">    outer_loop_by_checkpoints : bool, optional</span>
<span class="sd">        Whether to perform an outer loop over the checkpoints. Defaults to False.</span>
<span class="sd">    **kwargs : Any</span>
<span class="sd">        Additional keyword arguments passed to the explainer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.Tensor</span>
<span class="sd">        Self-influence scores for each datapoint in train_dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">self_influence_fn_from_explainer</span><span class="p">(</span>
        <span class="n">explainer_cls</span><span class="o">=</span><span class="n">CaptumTracInCPFastRandProj</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="n">outer_loop_by_checkpoints</span><span class="o">=</span><span class="n">outer_loop_by_checkpoints</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Dilya, Galip.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>