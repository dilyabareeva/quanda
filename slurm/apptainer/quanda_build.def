Bootstrap: docker
From: nvidia/cuda:11.7.1-cudnn8-devel-ubuntu20.04

%environment
  # The Anaconda environment needs to be available during execution
  export "PATH=/opt/conda/bin:$PATH"

%post
  apt-get -y update
  apt install -y git
  apt-get -y install curl

  # Downloads and installs Miniconda3
  curl -o ~/miniconda.sh -O https://repo.anaconda.com/miniconda/Miniconda3-py39_4.12.0-Linux-x86_64.sh

  chmod +x ~/miniconda.sh
  ~/miniconda.sh -b -u -p /opt/conda
  rm ~/miniconda.sh
  export "PATH=/opt/conda/bin:$PATH"
  export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CONDA_PREFIX/lib/

%files
  # Copies over the source code
  ./quanda /opt/quanda

%post
    export PYTHONPATH="/opt/quanda/"
    export LD_LIBRARY_PATH=/opt/conda/lib

%runscript
  # Starts the training of ResNet50 on the ImageNet dataset
  cd /opt/quanda
  pip install -e '.[tutorials]'
  python slurm/compute_explanations.py "$@"
